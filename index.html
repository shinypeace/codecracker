<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–∑–ª–æ–º–∞–π –∫–æ–¥</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* * =============================================
         * CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê –ò –¢–ï–ù–ò)
         * =============================================
         */
        :root {
            --background-color: #f0f4f8;
            --text-color: #1a202c;
            --card-background: #ffffff;
            --primary-color: #4a5568;
            --accent-color: #4299e1;
            --accent-color-hover: #2b6cb0;
            --button-text-color: #ffffff;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-color: #e2e8f0;
            --success-color: #48bb78;
            --error-color: #f56565;
            --table-header-bg: #edf2f7;
        }

        .dark-theme {
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --card-background: #2d3748;
            --primary-color: #cbd5e0;
            --accent-color: #63b3ed;
            --accent-color-hover: #90cdf4;
            --button-text-color: #1a202c;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --border-color: #4a5568;
            --table-header-bg: #4a5568;
        }

        /* * =============================================
         * –û–ë–©–ò–ï –°–¢–ò–õ–ò –ò –ú–ê–ö–ï–¢
         * =============================================
         */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }

        .app-container {
            background: var(--card-background);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-strong);
            width: 100%;
            max-width: 420px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        h1 { font-size: 2.2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; font-weight: 400; color: var(--primary-color); margin-top: 0; margin-bottom: 2rem; }
        h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem; }

        /* * =============================================
         * –°–¢–ò–õ–ò –≠–õ–ï–ú–ï–ù–¢–û–í –ò–ù–¢–ï–†–§–ï–ô–°–ê
         * =============================================
         */
        .button-group { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .button-group button, .submit-button {
            width: 100%;
            max-width: 300px;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            box-shadow: var(--shadow-light);
        }
        .button-group button { color: var(--button-text-color); background-color: var(--primary-color); }
        .button-group button:hover { transform: translateY(-3px); background-color: var(--accent-color); box-shadow: var(--shadow-strong); }

        .theme-switcher { display: flex; align-items: center; justify-content: center; margin-top: 2.5rem; gap: 0.75rem; color: var(--primary-color); }
        .theme-toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-toggle-switch input { display: none; }
        .theme-slider-track { position: absolute; cursor: pointer; inset: 0; background-color: var(--primary-color); transition: .4s; border-radius: 28px; }
        .theme-slider-track:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: var(--card-background); transition: .4s; border-radius: 50%; }
        input:checked + .theme-slider-track { background-color: var(--accent-color); }
        input:checked + .theme-slider-track:before { transform: translateX(22px); }

        /* * =============================================
         * –°–¢–ò–õ–ò –ò–ì–†–û–í–û–ì–û –≠–ö–†–ê–ù–ê
         * =============================================
         */
        #game-screen { justify-content: flex-start; gap: 1rem; }
        .game-header { width: 100%; text-align: center; }
        .game-header h2 { margin-bottom: 0.5rem; }
        
        .feedback-message { font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; min-height: 1.5em; color: var(--primary-color); transition: opacity 0.3s ease; }

        .code-input-container { display: flex; gap: 0.75rem; width: 100%; max-width: 400px; justify-content: center; align-items: stretch; margin: 1rem 0; }
        .code-digit-wrapper { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; flex: 1; min-width: 40px; }
        .code-digit { width: 100%; aspect-ratio: 1 / 1.2; max-height: 70px; font-size: clamp(1.5rem, 8vw, 2.5rem); font-weight: 700; border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: var(--card-background); color: var(--text-color); display: flex; align-items: center; justify-content: center; user-select: none; transition: transform 0.1s ease-out, border-color 0.2s; }
        .digit-control-button { background: var(--primary-color); color: var(--button-text-color); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, background-color 0.2s; display: flex; justify-content: center; align-items: center; line-height: 1; }
        .digit-control-button:hover { transform: scale(1.1); background-color: var(--accent-color); }
        
        .game-footer { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: auto; }
        .submit-button { background-color: var(--accent-color); color: white; }
        .submit-button:hover { background-color: var(--accent-color-hover); transform: translateY(-3px); box-shadow: var(--shadow-strong); }
        
        .pause-button-icon { position: absolute; top: 1.5rem; right: 1.5rem; width: 44px; height: 44px; background-color: var(--border-color); border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, transform 0.2s; z-index: 10; }
        .pause-button-icon:hover { background-color: #ccc; transform: scale(1.05); }
        .dark-theme .pause-button-icon { background-color: var(--border-color); }
        .dark-theme .pause-button-icon:hover { background-color: #5a687f; }
        .pause-button-icon svg { width: 24px; height: 24px; fill: var(--primary-color); }

        .history-container { width: 100%; max-height: 150px; background-color: rgba(0,0,0,0.05); border-radius: 0.75rem; padding: 0.75rem; display: flex; flex-direction: column; }
        .dark-theme .history-container { background-color: rgba(255,255,255,0.05); }
        .history-container h3 { font-size: 0.9rem; margin: 0 0 0.5rem 0; text-align: center; color: var(--primary-color); flex-shrink: 0; }
        .history-table-wrapper { overflow-y: auto; flex-grow: 1; }
        .history-table-wrapper::-webkit-scrollbar { width: 5px; }
        .history-table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .history-table-wrapper::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 5px; }
        #history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        #history-table th, #history-table td { padding: 0.35rem; text-align: center; }
        #history-table th { font-weight: 600; color: var(--primary-color); }
        #history-table td:first-child { font-family: 'Roboto Mono', monospace; font-weight: 500; letter-spacing: 1px; }

        /* * =============================================
         * –°–¢–ò–õ–ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù
         * =============================================
         */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--card-background); padding: 2rem; border-radius: 1.5rem; box-shadow: var(--shadow-strong); width: 90%; max-width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--primary-color); }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { display: flex; justify-content: center; gap: 1rem; }
        .modal-footer button { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 0.75rem; cursor: pointer; transition: transform 0.2s; }
        .modal-footer .confirm { background: var(--accent-color); color: white; }
        .modal-footer .cancel { background: var(--border-color); color: var(--text-color); }

        .length-slider-container { display: flex; align-items: center; justify-content: center; margin: 1rem 0 1.5rem 0; gap: 1rem; }
        #lengthSlider { flex-grow: 1; }
        #lengthValue { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); width: 40px; text-align: center; }
        
        .stats-table-container { width: 100%; overflow-x: auto; }
        .stats-modal table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem; }
        .stats-modal th, .stats-modal td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--border-color); }
        .stats-modal th { font-weight: 600; background-color: var(--table-header-bg); font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="app-container">
        
        <div class="screen" id="main-menu">
            <h1>–í–∑–ª–æ–º–∞–π –∫–æ–¥</h1>
            <h2>–û—Ç–≥–∞–¥–∞–π —Å–µ–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é</h2>
            <div class="button-group">
                <button id="mode-more-less">–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ</button>
                <button id="mode-correct-incorrect">–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ</button>
                <button id="show-stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button id="show-rules">–ü—Ä–∞–≤–∏–ª–∞</button>
            </div>
            <div class="theme-switcher">
                <span role="img" aria-label="–°–æ–ª–Ω—Ü–µ">‚òÄÔ∏è</span>
                <label class="theme-toggle-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="theme-slider-track"></span>
                </label>
                <span role="img" aria-label="–õ—É–Ω–∞">üåô</span>
            </div>
        </div>

        <div class="screen hidden" id="game-screen">
            <button class="pause-button-icon" id="pause-button">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
            <div class="game-header">
                <h2 id="game-mode-title"></h2>
                <p>–ü–æ–ø—ã—Ç–æ–∫: <span id="attempts-count">0</span></p>
            </div>
            <div class="feedback-message" id="feedback-message"></div>
            <div class="code-input-container" id="code-input-container"></div>
            <div class="game-footer">
                <button class="submit-button" id="guess-button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                <div class="history-container">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤</h3>
                    <div class="history-table-wrapper">
                        <table id="history-table">
                            <thead><tr><th>–ö–æ–¥</th><th>–û—Ç–≤–µ—Ç</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay" id="length-modal-overlay">
        <div class="modal">
            <div class="modal-header">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏–Ω—É –∫–æ–¥–∞</div>
            <div class="modal-body">
                <p>–û—Ç 4 –¥–æ 8 —Ü–∏—Ñ—Ä</p>
                <div class="length-slider-container">
                    <input type="range" min="4" max="8" value="4" id="lengthSlider">
                    <span id="lengthValue">4</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="start-game-button">–ò–≥—Ä–∞—Ç—å</button>
                <button class="cancel" id="cancel-length-button">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="stats-modal-overlay">
        <div class="modal stats-modal">
            <div class="modal-header">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</div>
            <div class="modal-body">
                <div class="stats-table-container">
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>–î–ª–∏–Ω–∞</th>
                                <th>–†–µ–∫–æ—Ä–¥ (–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ)</th>
                                <th>–†–µ–∫–æ—Ä–¥ (–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="close-stats-button">–û–∫</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rules-modal-overlay">
        <div class="modal">
            <div class="modal-header">–ü—Ä–∞–≤–∏–ª–∞</div>
            <div class="modal-body" style="text-align: left;">
                <h3>–†–µ–∂–∏–º ¬´–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ¬ª</h3>
                <p>–í–∞—à–∞ —Ü–µ–ª—å ‚Äî —É–≥–∞–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤–∞–º —Å–æ–æ–±—â–∞–µ—Ç—Å—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–≥–∞–¥–∞–Ω–Ω—ã–π –∫–æ–¥ –±–æ–ª—å—à–µ –∏–ª–∏ –º–µ–Ω—å—à–µ –≤–∞—à–µ–≥–æ –≤–≤–æ–¥–∞.</p>
                <h3>–†–µ–∂–∏–º ¬´–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ¬ª</h3>
                <p>–í–∞—à–∞ —Ü–µ–ª—å ‚Äî —É–≥–∞–¥–∞—Ç—å –∫–æ–¥. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤—ã —É–∑–Ω–∞–µ—Ç–µ, —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä —Å—Ç–æ—è—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö.</p>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="close-rules-button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="pause-modal-overlay">
        <div class="modal">
            <div class="modal-header">–ü–∞—É–∑–∞</div>
            <div class="modal-body">
                <div class="button-group">
                    <button class="confirm" id="resume-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    <button class="cancel" id="restart-button">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    <button class="cancel" id="menu-button">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="win-modal-overlay">
        <div class="modal">
            <div class="modal-header" id="win-modal-header"></div>
            <div class="modal-body"><p id="win-modal-message"></p></div>
            <div class="modal-footer">
                <button class="confirm" id="play-again-button">–ï—â—ë —Ä–∞–∑</button>
                <button class="cancel" id="win-to-menu-button">–í –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
            const STATS_VK_KEY = 'codeCrackerScores_v1';
            let gameMode = '';
            let secretCode = '';
            let codeLength = 4;
            let attempts = 0;
            let bestScores = {};
            let isGameActive = false;
            let guessHistory = [];
            
            // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è VK SDK ---
            let isVK = false;
            let winCountForAd = 0;

            // --- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ---
            const mainMenu = document.getElementById('main-menu');
            const gameScreen = document.getElementById('game-screen');
            const modals = {
                length: document.getElementById('length-modal-overlay'),
                stats: document.getElementById('stats-modal-overlay'),
                rules: document.getElementById('rules-modal-overlay'),
                pause: document.getElementById('pause-modal-overlay'),
                win: document.getElementById('win-modal-overlay')
            };
            const lengthSlider = document.getElementById('lengthSlider');
            const lengthValueSpan = document.getElementById('lengthValue');
            const feedbackMessage = document.getElementById('feedback-message');
            const codeInputContainer = document.getElementById('code-input-container');
            const attemptsCountSpan = document.getElementById('attempts-count');
            const guessButton = document.getElementById('guess-button');
            const themeToggle = document.getElementById('theme-toggle');
            const statsTableBody = document.querySelector('#stats-table tbody');
            const historyTableBody = document.querySelector('#history-table tbody');

            // --- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è VK Bridge ---
            async function initVK() {
                try {
                    await vkBridge.send('VKWebAppInit');
                    isVK = true;
                    console.log('VK Bridge initialized');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä–Ω—É—é —Ä–µ–∫–ª–∞–º—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    vkBridge.send("VKWebAppShowBannerAd", { banner_location: 'bottom' })
                        .catch(e => console.error("Banner Ad Init Error:", e));
                } catch (error) {
                    console.error('VK Bridge init failed:', error);
                    isVK = false;
                } finally {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ (–∏–∑ VK –∏–ª–∏ localStorage)
                    await loadStats();
                }
            }

            async function saveStats() {
                const dataString = JSON.stringify(bestScores);
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                localStorage.setItem(STATS_VK_KEY, dataString);

                if (isVK) {
                    try {
                        await vkBridge.send('VKWebAppStorageSet', { key: STATS_VK_KEY, value: dataString });
                        console.log('Stats saved to VK Storage');
                    } catch (e) {
                        console.error('VK Storage save failed:', e);
                    }
                }
            }

            async function loadStats() {
                let loadedData = null;
                if (isVK) {
                    try {
                        const data = await vkBridge.send('VKWebAppStorageGet', { keys: [STATS_VK_KEY] });
                        if (data.keys[0].value) {
                            loadedData = data.keys[0].value;
                            console.log('Stats loaded from VK Storage');
                        }
                    } catch (e) { 
                        console.error('VK Storage load failed, falling back to localStorage:', e);
                    }
                }
                
                if (!loadedData) {
                    loadedData = localStorage.getItem(STATS_VK_KEY);
                    console.log('Stats loaded from localStorage');
                }

                if (loadedData) {
                    bestScores = JSON.parse(loadedData);
                } else {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –Ω–∏–≥–¥–µ
                    bestScores = { '–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ': {}, '–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ': {} };
                }
            }
            
            // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI ---
            const showScreen = (screenToShow) => {
                [mainMenu, gameScreen].forEach(screen => screen.classList.add('hidden'));
                screenToShow.classList.remove('hidden');
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Å–º–µ–Ω–µ —ç–∫—Ä–∞–Ω–∞
                if (isVK) {
                    vkBridge.send("VKWebAppShowBannerAd", { banner_location: 'bottom' })
                           .catch(e => console.error("Banner Ad Error on screen change:", e));
                }
            };
            const showModal = (modal) => modal.classList.add('active');
            const hideModal = (modal) => modal.classList.remove('active');
            
            // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
            const startGame = (mode, length) => {
                gameMode = mode;
                codeLength = length;
                attempts = 0;
                guessHistory = [];
                isGameActive = true;
                secretCode = Array.from({ length: codeLength }, () => Math.floor(Math.random() * 10)).join('');
                updateGameUI();
                generateCodeInputs();
                showScreen(gameScreen);
            };

            const updateGameUI = () => {
                document.getElementById('game-mode-title').textContent = gameMode;
                attemptsCountSpan.textContent = attempts;
                feedbackMessage.textContent = '';
                guessButton.disabled = false;
                renderHistory();
            };

            const generateCodeInputs = () => {
                codeInputContainer.innerHTML = '';
                for (let i = 0; i < codeLength; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-digit-wrapper';
                    wrapper.innerHTML = `
                        <button class="digit-control-button up" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å —Ü–∏—Ñ—Ä—É ${i+1}">‚ñ≤</button>
                        <div class="code-digit" role="spinbutton" aria-valuenow="0">0</div>
                        <button class="digit-control-button down" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å —Ü–∏—Ñ—Ä—É ${i+1}">‚ñº</button>
                    `;
                    wrapper.querySelector('.up').addEventListener('click', () => updateDigit(i, 1));
                    wrapper.querySelector('.down').addEventListener('click', () => updateDigit(i, -1));
                    codeInputContainer.appendChild(wrapper);
                }
            };

            const updateDigit = (index, delta) => {
                const digitEl = codeInputContainer.children[index].querySelector('.code-digit');
                let currentValue = parseInt(digitEl.textContent);
                currentValue = (currentValue + delta + 10) % 10;
                digitEl.textContent = currentValue;
                digitEl.setAttribute('aria-valuenow', currentValue);
            };

            const checkGuess = () => {
                if (!isGameActive) return;
                attempts++;
                attemptsCountSpan.textContent = attempts;
                const userGuess = Array.from(codeInputContainer.querySelectorAll('.code-digit')).map(el => el.textContent).join('');
                let feedbackText = '';

                if (userGuess === secretCode) {
                    isGameActive = false;
                    guessButton.disabled = true;
                    feedbackText = `üéâ –í—ã —É–≥–∞–¥–∞–ª–∏ –∑–∞ ${attempts} –ø–æ–ø—ã—Ç–æ–∫!`;
                    
                    if (!bestScores[gameMode][codeLength] || attempts < bestScores[gameMode][codeLength]) {
                        bestScores[gameMode][codeLength] = attempts;
                        saveStats(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥
                    }
                    
                    winCountForAd++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–±–µ–¥ –¥–ª—è —Ä–µ–∫–ª–∞–º—ã
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–∂—Å—Ç—Ä–∞–Ω–∏—á–Ω—É—é —Ä–µ–∫–ª–∞–º—É –ø–æ—Å–ª–µ –¥–≤—É—Ö –ø–æ–±–µ–¥
                    if (isVK && winCountForAd >= 2) {
                        winCountForAd = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                        vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'interstitial' })
                            .catch(e => console.error("Interstitial Ad Error:", e));
                    }

                    setTimeout(() => showWinModal(true, `–ö–æ–¥ ¬´${secretCode}¬ª –≤–∑–ª–æ–º–∞–Ω!`), 800);
                } else {
                    if (gameMode === '–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ') {
                        feedbackText = parseInt(userGuess) > parseInt(secretCode) ? `‚Üì –ö–æ–¥ –º–µ–Ω—å—à–µ` : `‚Üë –ö–æ–¥ –±–æ–ª—å—à–µ`;
                    } else {
                        const correctCount = userGuess.split('').filter((digit, i) => digit === secretCode[i]).length;
                        feedbackText = `–í–µ—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${correctCount}`;
                    }
                }
                feedbackMessage.textContent = feedbackText;
                guessHistory.push({ guess: userGuess, feedback: feedbackText.startsWith('üéâ') ? '–ü–æ–±–µ–¥–∞!' : feedbackText });
                renderHistory();
            };

            const showWinModal = (isWin, message) => {
                document.getElementById('win-modal-header').textContent = isWin ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' : '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞';
                document.getElementById('win-modal-message').textContent = message;
                showModal(modals.win);
            };

            const renderHistory = () => {
                historyTableBody.innerHTML = '';
                if (guessHistory.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="2">...</td></tr>';
                    return;
                }
                [...guessHistory].reverse().forEach(entry => {
                    const row = historyTableBody.insertRow();
                    row.innerHTML = `<td>${entry.guess}</td><td>${entry.feedback}</td>`;
                });
            };
            
            const renderStats = () => {
                statsTableBody.innerHTML = '';
                for (let length = 4; length <= 8; length++) {
                    const scoreMoreLessRaw = bestScores['–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ']?.[length];
                    const scoreCorrectIncorrectRaw = bestScores['–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ']?.[length];
                    const scoreMoreLess = scoreMoreLessRaw ? `${scoreMoreLessRaw} –ø–æ–ø—ã—Ç–æ–∫` : '‚Äî';
                    const scoreCorrectIncorrect = scoreCorrectIncorrectRaw ? `${scoreCorrectIncorrectRaw} –ø–æ–ø—ã—Ç–æ–∫` : '‚Äî';
                    const row = statsTableBody.insertRow();
                    row.innerHTML = `<td>${length} —Ü–∏—Ñ—Ä</td><td>${scoreMoreLess}</td><td>${scoreCorrectIncorrect}</td>`;
                }
            };

            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
            document.getElementById('mode-more-less').addEventListener('click', () => { gameMode = '–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ'; showModal(modals.length); });
            document.getElementById('mode-correct-incorrect').addEventListener('click', () => { gameMode = '–í–µ—Ä–Ω–æ/–ù–µ –≤–µ—Ä–Ω–æ'; showModal(modals.length); });
            document.getElementById('show-stats').addEventListener('click', () => { renderStats(); showModal(modals.stats); });
            document.getElementById('show-rules').addEventListener('click', () => showModal(modals.rules));
            lengthSlider.addEventListener('input', () => { lengthValueSpan.textContent = lengthSlider.value; });
            document.getElementById('start-game-button').addEventListener('click', () => {
                hideModal(modals.length);
                startGame(gameMode, parseInt(lengthSlider.value));
            });
            document.getElementById('cancel-length-button').addEventListener('click', () => hideModal(modals.length));
            document.getElementById('close-stats-button').addEventListener('click', () => hideModal(modals.stats));
            document.getElementById('close-rules-button').addEventListener('click', () => hideModal(modals.rules));
            guessButton.addEventListener('click', checkGuess);
            document.getElementById('pause-button').addEventListener('click', () => showModal(modals.pause));
            document.getElementById('resume-button').addEventListener('click', () => hideModal(modals.pause));
            document.getElementById('restart-button').addEventListener('click', () => { hideModal(modals.pause); startGame(gameMode, codeLength); });
            document.getElementById('menu-button').addEventListener('click', () => { hideModal(modals.pause); showScreen(mainMenu); });
            document.getElementById('play-again-button').addEventListener('click', () => { hideModal(modals.win); startGame(gameMode, codeLength); });
            document.getElementById('win-to-menu-button').addEventListener('click', () => { hideModal(modals.win); showScreen(mainMenu); });
            themeToggle.addEventListener('change', (e) => document.body.classList.toggle('dark-theme', e.target.checked));

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
            initVK();
        });
    </script>
</body>
</html>

