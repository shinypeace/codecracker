<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Взломай код</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* * =============================================
         * CSS ПЕРЕМЕННЫЕ (ЦВЕТОВАЯ ПАЛИТРА И ТЕНИ)
         * =============================================
         */
        :root {
            --background-color: #f0f4f8;
            --text-color: #1a202c;
            --card-background: #ffffff;
            --primary-color: #4a5568;
            --accent-color: #4299e1;
            --accent-color-hover: #2b6cb0;
            --button-text-color: #ffffff;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-color: #e2e8f0;
            --success-color: #48bb78;
            --error-color: #f56565;
            --table-header-bg: #edf2f7;
        }

        .dark-theme {
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --card-background: #2d3748;
            --primary-color: #cbd5e0;
            --accent-color: #63b3ed;
            --accent-color-hover: #90cdf4;
            --button-text-color: #1a202c;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --border-color: #4a5568;
            --table-header-bg: #4a5568;
        }

        /* * =============================================
         * ОБЩИЕ СТИЛИ И МАКЕТ
         * =============================================
         */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }

        .app-container {
            background: var(--card-background);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-strong);
            width: 100%;
            max-width: 420px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        h1 { font-size: 2.2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; font-weight: 400; color: var(--primary-color); margin-top: 0; margin-bottom: 2rem; }
        h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem; }

        /* * =============================================
         * СТИЛИ ЭЛЕМЕНТОВ ИНТЕРФЕЙСА
         * =============================================
         */
        .button-group { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .button-group button, .submit-button {
            width: 100%;
            max-width: 300px;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            box-shadow: var(--shadow-light);
        }
        .button-group button { color: var(--button-text-color); background-color: var(--primary-color); }
        .button-group button:hover { transform: translateY(-3px); background-color: var(--accent-color); box-shadow: var(--shadow-strong); }

        .theme-switcher { display: flex; align-items: center; justify-content: center; margin-top: 2.5rem; gap: 0.75rem; color: var(--primary-color); }
        .theme-toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-toggle-switch input { display: none; }
        .theme-slider-track { position: absolute; cursor: pointer; inset: 0; background-color: var(--primary-color); transition: .4s; border-radius: 28px; }
        .theme-slider-track:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: var(--card-background); transition: .4s; border-radius: 50%; }
        input:checked + .theme-slider-track { background-color: var(--accent-color); }
        input:checked + .theme-slider-track:before { transform: translateX(22px); }

        /* * =============================================
         * СТИЛИ ИГРОВОГО ЭКРАНА
         * =============================================
         */
        #game-screen { justify-content: flex-start; gap: 1rem; }
        .game-header { width: 100%; text-align: center; }
        .game-header h2 { margin-bottom: 0.5rem; }
        
        .feedback-message { font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; min-height: 1.5em; color: var(--primary-color); transition: opacity 0.3s ease; }

        .code-input-container { display: flex; gap: 0.75rem; width: 100%; max-width: 400px; justify-content: center; align-items: stretch; margin: 1rem 0; }
        .code-digit-wrapper { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; flex: 1; min-width: 40px; }
        .code-digit { width: 100%; aspect-ratio: 1 / 1.2; max-height: 70px; font-size: clamp(1.5rem, 8vw, 2.5rem); font-weight: 700; border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: var(--card-background); color: var(--text-color); display: flex; align-items: center; justify-content: center; user-select: none; transition: transform 0.1s ease-out, border-color 0.2s; }
        .digit-control-button { background: var(--primary-color); color: var(--button-text-color); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, background-color 0.2s; display: flex; justify-content: center; align-items: center; line-height: 1; }
        .digit-control-button:hover { transform: scale(1.1); background-color: var(--accent-color); }
        
        .game-footer { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: auto; }
        .submit-button { background-color: var(--accent-color); color: white; }
        .submit-button:hover { background-color: var(--accent-color-hover); transform: translateY(-3px); box-shadow: var(--shadow-strong); }
        
        .pause-button-icon { position: absolute; top: 1.5rem; right: 1.5rem; width: 44px; height: 44px; background-color: var(--border-color); border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, transform 0.2s; z-index: 10; }
        .pause-button-icon:hover { background-color: #ccc; transform: scale(1.05); }
        .dark-theme .pause-button-icon { background-color: var(--border-color); }
        .dark-theme .pause-button-icon:hover { background-color: #5a687f; }
        .pause-button-icon svg { width: 24px; height: 24px; fill: var(--primary-color); }

        .history-container { width: 100%; max-height: 150px; background-color: rgba(0,0,0,0.05); border-radius: 0.75rem; padding: 0.75rem; display: flex; flex-direction: column; }
        .dark-theme .history-container { background-color: rgba(255,255,255,0.05); }
        .history-container h3 { font-size: 0.9rem; margin: 0 0 0.5rem 0; text-align: center; color: var(--primary-color); flex-shrink: 0; }
        .history-table-wrapper { overflow-y: auto; flex-grow: 1; }
        .history-table-wrapper::-webkit-scrollbar { width: 5px; }
        .history-table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .history-table-wrapper::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 5px; }
        #history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        #history-table th, #history-table td { padding: 0.35rem; text-align: center; }
        #history-table th { font-weight: 600; color: var(--primary-color); }
        #history-table td:first-child { font-family: 'Roboto Mono', monospace; font-weight: 500; letter-spacing: 1px; }

        /* * =============================================
         * СТИЛИ МОДАЛЬНЫХ ОКОН
         * =============================================
         */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--card-background); padding: 2rem; border-radius: 1.5rem; box-shadow: var(--shadow-strong); width: 90%; max-width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--primary-color); }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { display: flex; justify-content: center; gap: 1rem; }
        .modal-footer button { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 0.75rem; cursor: pointer; transition: transform 0.2s; }
        .modal-footer .confirm { background: var(--accent-color); color: white; }
        .modal-footer .cancel { background: var(--border-color); color: var(--text-color); }

        .length-slider-container { display: flex; align-items: center; justify-content: center; margin: 1rem 0 1.5rem 0; gap: 1rem; }
        #lengthSlider { flex-grow: 1; }
        #lengthValue { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); width: 40px; text-align: center; }
        
        .stats-table-container { width: 100%; overflow-x: auto; }
        .stats-modal table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem; }
        .stats-modal th, .stats-modal td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--border-color); }
        .stats-modal th { font-weight: 600; background-color: var(--table-header-bg); font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="app-container">
        
        <div class="screen" id="main-menu">
            <h1>Взломай код</h1>
            <h2>Отгадай секретную комбинацию</h2>
            <div class="button-group">
                <button id="mode-more-less">Больше/Меньше</button>
                <button id="mode-correct-incorrect">Верно/Не верно</button>
                <button id="show-stats">Статистика</button>
                <button id="show-rules">Правила</button>
            </div>
            <div class="theme-switcher">
                <span role="img" aria-label="Солнце">☀️</span>
                <label class="theme-toggle-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="theme-slider-track"></span>
                </label>
                <span role="img" aria-label="Луна">🌙</span>
            </div>
        </div>

        <div class="screen hidden" id="game-screen">
            <button class="pause-button-icon" id="pause-button">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
            </button>
            <div class="game-header">
                <h2 id="game-mode-title"></h2>
                <p>Попыток: <span id="attempts-count">0</span></p>
            </div>
            <div class="feedback-message" id="feedback-message"></div>
            <div class="code-input-container" id="code-input-container"></div>
            <div class="game-footer">
                <button class="submit-button" id="guess-button">Проверить</button>
                <div class="history-container">
                    <h3>История ходов</h3>
                    <div class="history-table-wrapper">
                        <table id="history-table">
                            <thead><tr><th>Код</th><th>Ответ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal-overlay" id="length-modal-overlay">
        <div class="modal">
            <div class="modal-header">Выберите длину кода</div>
            <div class="modal-body">
                <p>От 4 до 8 цифр</p>
                <div class="length-slider-container">
                    <input type="range" min="4" max="8" value="4" id="lengthSlider">
                    <span id="lengthValue">4</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="start-game-button">Играть</button>
                <button class="cancel" id="cancel-length-button">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="stats-modal-overlay">
        <div class="modal stats-modal">
            <div class="modal-header">Статистика рекордов</div>
            <div class="modal-body">
                <div class="stats-table-container">
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>Длина</th>
                                <th>Рекорд (Больше/Меньше)</th>
                                <th>Рекорд (Верно/Не верно)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="close-stats-button">Ок</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rules-modal-overlay">
        <div class="modal">
            <div class="modal-header">Правила</div>
            <div class="modal-body" style="text-align: left;">
                <h3>Режим «Больше/Меньше»</h3>
                <p>Ваша цель — угадать секретный код. После каждой попытки вам сообщается, является ли загаданный код больше или меньше вашего ввода.</p>
                <h3>Режим «Верно/Не верно»</h3>
                <p>Ваша цель — угадать код. После каждой попытки вы узнаете, сколько цифр стоят на правильных позициях.</p>
            </div>
            <div class="modal-footer">
                <button class="confirm" id="close-rules-button">Закрыть</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="pause-modal-overlay">
        <div class="modal">
            <div class="modal-header">Пауза</div>
            <div class="modal-body">
                <div class="button-group">
                    <button class="confirm" id="resume-button">Продолжить</button>
                    <button class="cancel" id="restart-button">Начать заново</button>
                    <button class="cancel" id="menu-button">Главное меню</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="win-modal-overlay">
        <div class="modal">
            <div class="modal-header" id="win-modal-header"></div>
            <div class="modal-body"><p id="win-modal-message"></p></div>
            <div class="modal-footer">
                <button class="confirm" id="play-again-button">Ещё раз</button>
                <button class="cancel" id="win-to-menu-button">В меню</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Глобальные переменные и константы ---
            const STATS_VK_KEY = 'codeCrackerScores_v1';
            let gameMode = '';
            let secretCode = '';
            let codeLength = 4;
            let attempts = 0;
            let bestScores = {};
            let isGameActive = false;
            let guessHistory = [];
            
            // --- Переменные для VK SDK ---
            let isVK = false;
            let winCountForAd = 0;

            // --- Кэширование DOM элементов ---
            const mainMenu = document.getElementById('main-menu');
            const gameScreen = document.getElementById('game-screen');
            const modals = {
                length: document.getElementById('length-modal-overlay'),
                stats: document.getElementById('stats-modal-overlay'),
                rules: document.getElementById('rules-modal-overlay'),
                pause: document.getElementById('pause-modal-overlay'),
                win: document.getElementById('win-modal-overlay')
            };
            const lengthSlider = document.getElementById('lengthSlider');
            const lengthValueSpan = document.getElementById('lengthValue');
            const feedbackMessage = document.getElementById('feedback-message');
            const codeInputContainer = document.getElementById('code-input-container');
            const attemptsCountSpan = document.getElementById('attempts-count');
            const guessButton = document.getElementById('guess-button');
            const themeToggle = document.getElementById('theme-toggle');
            const statsTableBody = document.querySelector('#stats-table tbody');
            const historyTableBody = document.querySelector('#history-table tbody');

            // --- Интеграция VK Bridge ---
            async function initVK() {
                try {
                    await vkBridge.send('VKWebAppInit');
                    isVK = true;
                    console.log('VK Bridge initialized');
                    // Показываем баннерную рекламу сразу после инициализации
                    vkBridge.send("VKWebAppShowBannerAd", { banner_location: 'bottom' })
                        .catch(e => console.error("Banner Ad Init Error:", e));
                } catch (error) {
                    console.error('VK Bridge init failed:', error);
                    isVK = false;
                } finally {
                    // Загружаем статистику в любом случае (из VK или localStorage)
                    await loadStats();
                }
            }

            async function saveStats() {
                const dataString = JSON.stringify(bestScores);
                // Сначала сохраняем локально на случай ошибки
                localStorage.setItem(STATS_VK_KEY, dataString);

                if (isVK) {
                    try {
                        await vkBridge.send('VKWebAppStorageSet', { key: STATS_VK_KEY, value: dataString });
                        console.log('Stats saved to VK Storage');
                    } catch (e) {
                        console.error('VK Storage save failed:', e);
                    }
                }
            }

            async function loadStats() {
                let loadedData = null;
                if (isVK) {
                    try {
                        const data = await vkBridge.send('VKWebAppStorageGet', { keys: [STATS_VK_KEY] });
                        if (data.keys[0].value) {
                            loadedData = data.keys[0].value;
                            console.log('Stats loaded from VK Storage');
                        }
                    } catch (e) { 
                        console.error('VK Storage load failed, falling back to localStorage:', e);
                    }
                }
                
                if (!loadedData) {
                    loadedData = localStorage.getItem(STATS_VK_KEY);
                    console.log('Stats loaded from localStorage');
                }

                if (loadedData) {
                    bestScores = JSON.parse(loadedData);
                } else {
                    // Инициализация пустой структуры, если данных нет нигде
                    bestScores = { 'Больше/Меньше': {}, 'Верно/Не верно': {} };
                }
            }
            
            // --- Управление UI ---
            const showScreen = (screenToShow) => {
                [mainMenu, gameScreen].forEach(screen => screen.classList.add('hidden'));
                screenToShow.classList.remove('hidden');
                // Обновляем баннер при каждой смене экрана
                if (isVK) {
                    vkBridge.send("VKWebAppShowBannerAd", { banner_location: 'bottom' })
                           .catch(e => console.error("Banner Ad Error on screen change:", e));
                }
            };
            const showModal = (modal) => modal.classList.add('active');
            const hideModal = (modal) => modal.classList.remove('active');
            
            // --- Логика игры ---
            const startGame = (mode, length) => {
                gameMode = mode;
                codeLength = length;
                attempts = 0;
                guessHistory = [];
                isGameActive = true;
                secretCode = Array.from({ length: codeLength }, () => Math.floor(Math.random() * 10)).join('');
                updateGameUI();
                generateCodeInputs();
                showScreen(gameScreen);
            };

            const updateGameUI = () => {
                document.getElementById('game-mode-title').textContent = gameMode;
                attemptsCountSpan.textContent = attempts;
                feedbackMessage.textContent = '';
                guessButton.disabled = false;
                renderHistory();
            };

            const generateCodeInputs = () => {
                codeInputContainer.innerHTML = '';
                for (let i = 0; i < codeLength; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-digit-wrapper';
                    wrapper.innerHTML = `
                        <button class="digit-control-button up" aria-label="Увеличить цифру ${i+1}">▲</button>
                        <div class="code-digit" role="spinbutton" aria-valuenow="0">0</div>
                        <button class="digit-control-button down" aria-label="Уменьшить цифру ${i+1}">▼</button>
                    `;
                    wrapper.querySelector('.up').addEventListener('click', () => updateDigit(i, 1));
                    wrapper.querySelector('.down').addEventListener('click', () => updateDigit(i, -1));
                    codeInputContainer.appendChild(wrapper);
                }
            };

            const updateDigit = (index, delta) => {
                const digitEl = codeInputContainer.children[index].querySelector('.code-digit');
                let currentValue = parseInt(digitEl.textContent);
                currentValue = (currentValue + delta + 10) % 10;
                digitEl.textContent = currentValue;
                digitEl.setAttribute('aria-valuenow', currentValue);
            };

            const checkGuess = () => {
                if (!isGameActive) return;
                attempts++;
                attemptsCountSpan.textContent = attempts;
                const userGuess = Array.from(codeInputContainer.querySelectorAll('.code-digit')).map(el => el.textContent).join('');
                let feedbackText = '';

                if (userGuess === secretCode) {
                    isGameActive = false;
                    guessButton.disabled = true;
                    feedbackText = `🎉 Вы угадали за ${attempts} попыток!`;
                    
                    if (!bestScores[gameMode][codeLength] || attempts < bestScores[gameMode][codeLength]) {
                        bestScores[gameMode][codeLength] = attempts;
                        saveStats(); // Сохраняем новый рекорд
                    }
                    
                    winCountForAd++; // Увеличиваем счетчик побед для рекламы
                    
                    // Показываем межстраничную рекламу после двух побед
                    if (isVK && winCountForAd >= 2) {
                        winCountForAd = 0; // Сбрасываем счетчик
                        vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'interstitial' })
                            .catch(e => console.error("Interstitial Ad Error:", e));
                    }

                    setTimeout(() => showWinModal(true, `Код «${secretCode}» взломан!`), 800);
                } else {
                    if (gameMode === 'Больше/Меньше') {
                        feedbackText = parseInt(userGuess) > parseInt(secretCode) ? `↓ Код меньше` : `↑ Код больше`;
                    } else {
                        const correctCount = userGuess.split('').filter((digit, i) => digit === secretCode[i]).length;
                        feedbackText = `Верных позиций: ${correctCount}`;
                    }
                }
                feedbackMessage.textContent = feedbackText;
                guessHistory.push({ guess: userGuess, feedback: feedbackText.startsWith('🎉') ? 'Победа!' : feedbackText });
                renderHistory();
            };

            const showWinModal = (isWin, message) => {
                document.getElementById('win-modal-header').textContent = isWin ? 'Поздравляем!' : 'Игра окончена';
                document.getElementById('win-modal-message').textContent = message;
                showModal(modals.win);
            };

            const renderHistory = () => {
                historyTableBody.innerHTML = '';
                if (guessHistory.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="2">...</td></tr>';
                    return;
                }
                [...guessHistory].reverse().forEach(entry => {
                    const row = historyTableBody.insertRow();
                    row.innerHTML = `<td>${entry.guess}</td><td>${entry.feedback}</td>`;
                });
            };
            
            const renderStats = () => {
                statsTableBody.innerHTML = '';
                for (let length = 4; length <= 8; length++) {
                    const scoreMoreLessRaw = bestScores['Больше/Меньше']?.[length];
                    const scoreCorrectIncorrectRaw = bestScores['Верно/Не верно']?.[length];
                    const scoreMoreLess = scoreMoreLessRaw ? `${scoreMoreLessRaw} попыток` : '—';
                    const scoreCorrectIncorrect = scoreCorrectIncorrectRaw ? `${scoreCorrectIncorrectRaw} попыток` : '—';
                    const row = statsTableBody.insertRow();
                    row.innerHTML = `<td>${length} цифр</td><td>${scoreMoreLess}</td><td>${scoreCorrectIncorrect}</td>`;
                }
            };

            // --- Обработчики событий ---
            document.getElementById('mode-more-less').addEventListener('click', () => { gameMode = 'Больше/Меньше'; showModal(modals.length); });
            document.getElementById('mode-correct-incorrect').addEventListener('click', () => { gameMode = 'Верно/Не верно'; showModal(modals.length); });
            document.getElementById('show-stats').addEventListener('click', () => { renderStats(); showModal(modals.stats); });
            document.getElementById('show-rules').addEventListener('click', () => showModal(modals.rules));
            lengthSlider.addEventListener('input', () => { lengthValueSpan.textContent = lengthSlider.value; });
            document.getElementById('start-game-button').addEventListener('click', () => {
                hideModal(modals.length);
                startGame(gameMode, parseInt(lengthSlider.value));
            });
            document.getElementById('cancel-length-button').addEventListener('click', () => hideModal(modals.length));
            document.getElementById('close-stats-button').addEventListener('click', () => hideModal(modals.stats));
            document.getElementById('close-rules-button').addEventListener('click', () => hideModal(modals.rules));
            guessButton.addEventListener('click', checkGuess);
            document.getElementById('pause-button').addEventListener('click', () => showModal(modals.pause));
            document.getElementById('resume-button').addEventListener('click', () => hideModal(modals.pause));
            document.getElementById('restart-button').addEventListener('click', () => { hideModal(modals.pause); startGame(gameMode, codeLength); });
            document.getElementById('menu-button').addEventListener('click', () => { hideModal(modals.pause); showScreen(mainMenu); });
            document.getElementById('play-again-button').addEventListener('click', () => { hideModal(modals.win); startGame(gameMode, codeLength); });
            document.getElementById('win-to-menu-button').addEventListener('click', () => { hideModal(modals.win); showScreen(mainMenu); });
            themeToggle.addEventListener('change', (e) => document.body.classList.toggle('dark-theme', e.target.checked));

            // --- Инициализация приложения ---
            initVK();
        });
    </script>
</body>
</html>

